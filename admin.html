<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Product Manager | The Mitzvah Studio</title>
    <link rel="icon" type="image/svg+xml" href="assets/Submark.svg">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Sora:wght@600;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --electric-blue: #2563EB;
            --hot-pink: #EC4899;
            --white: #FFFFFF;
            --rich-black: #0F172A;
            --gold: #D4AF37;
            --gradient: linear-gradient(135deg, var(--electric-blue) 0%, var(--hot-pink) 100%);
            --gradient-subtle: linear-gradient(135deg, rgba(37, 99, 235, 0.1) 0%, rgba(236, 72, 153, 0.1) 100%);
            --gray-50: #F8FAFC;
            --gray-100: #F1F5F9;
            --gray-200: #E2E8F0;
            --gray-300: #CBD5E1;
            --gray-400: #94A3B8;
            --gray-500: #64748B;
            --gray-600: #475569;
            --gray-700: #334155;
            --gray-800: #1E293B;
            --gray-900: #0F172A;
            --font-display: 'Sora', sans-serif;
            --font-body: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            --ease: cubic-bezier(0.16, 1, 0.3, 1);
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: var(--font-body);
            background: var(--gray-50);
            color: var(--gray-700);
            line-height: 1.6;
            font-size: 14px;
            height: 100vh;
            overflow: hidden;
        }

        /* Auth Gate */
        .auth-gate {
            position: fixed;
            inset: 0;
            background: var(--white);
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            gap: 24px;
        }
        .auth-gate.hidden { display: none; }
        .auth-gate h1 {
            font-family: var(--font-display);
            font-size: 24px;
            color: var(--rich-black);
        }
        .auth-gate p { color: var(--gray-500); font-size: 14px; }
        .auth-gate input {
            padding: 14px 20px;
            border: 2px solid var(--gray-200);
            border-radius: 12px;
            font-size: 16px;
            width: 300px;
            text-align: center;
            font-family: var(--font-body);
        }
        .auth-gate input:focus {
            outline: none;
            border-color: var(--electric-blue);
        }
        .auth-gate .auth-error {
            color: var(--hot-pink);
            font-size: 13px;
            display: none;
        }

        /* Layout */
        .app { display: flex; height: 100vh; flex-direction: column; }
        .app.locked { display: none; }

        /* Top Bar */
        .topbar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 24px;
            background: var(--rich-black);
            color: var(--white);
            flex-shrink: 0;
        }
        .topbar-left {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .topbar-logo { height: 24px; }
        .topbar h1 {
            font-family: var(--font-display);
            font-size: 15px;
            font-weight: 700;
        }
        .topbar-actions {
            display: flex;
            gap: 10px;
        }

        /* Buttons */
        .btn {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 8px 16px;
            font-size: 13px;
            font-weight: 600;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            border: none;
            font-family: var(--font-body);
        }
        .btn-primary {
            background: var(--gradient);
            color: var(--white);
        }
        .btn-primary:hover {
            box-shadow: 0 4px 15px rgba(37, 99, 235, 0.4);
            transform: translateY(-1px);
        }
        .btn-secondary {
            background: var(--gray-700);
            color: var(--white);
        }
        .btn-secondary:hover { background: var(--gray-600); }
        .btn-danger {
            background: transparent;
            color: var(--hot-pink);
            border: 1px solid var(--hot-pink);
        }
        .btn-danger:hover {
            background: var(--hot-pink);
            color: var(--white);
        }
        .btn-ghost {
            background: transparent;
            color: var(--gray-500);
            border: 1px solid var(--gray-200);
        }
        .btn-ghost:hover {
            border-color: var(--gray-400);
            color: var(--gray-700);
        }

        /* Main Area */
        .main {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        /* Sidebar - Product List */
        .sidebar {
            width: 280px;
            background: var(--white);
            border-right: 1px solid var(--gray-200);
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
        }
        .sidebar-header {
            padding: 16px;
            border-bottom: 1px solid var(--gray-100);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .sidebar-header h2 {
            font-family: var(--font-display);
            font-size: 13px;
            font-weight: 700;
            color: var(--gray-500);
            text-transform: uppercase;
            letter-spacing: 0.1em;
        }
        .product-count {
            font-size: 12px;
            color: var(--gray-400);
            background: var(--gray-100);
            padding: 2px 8px;
            border-radius: 100px;
        }
        .product-list {
            flex: 1;
            overflow-y: auto;
            padding: 8px;
        }
        .product-list-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 12px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s;
            margin-bottom: 2px;
        }
        .product-list-item:hover { background: var(--gray-50); }
        .product-list-item.active {
            background: var(--gradient-subtle);
            border: 1px solid rgba(37, 99, 235, 0.2);
        }
        .product-list-item .item-thumb {
            width: 36px;
            height: 36px;
            border-radius: 8px;
            background: var(--gray-100);
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            overflow: hidden;
        }
        .product-list-item .item-thumb img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .product-list-item .item-thumb svg {
            width: 20px;
            height: 20px;
            stroke: var(--gray-400);
        }
        .product-list-item .item-info { flex: 1; min-width: 0; }
        .product-list-item .item-name {
            font-size: 13px;
            font-weight: 600;
            color: var(--rich-black);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .product-list-item .item-meta {
            font-size: 11px;
            color: var(--gray-400);
        }
        .sidebar-footer {
            padding: 12px 16px;
            border-top: 1px solid var(--gray-100);
        }
        .btn-add {
            width: 100%;
            justify-content: center;
            padding: 10px;
        }

        /* Editor */
        .editor {
            flex: 1;
            overflow-y: auto;
            padding: 32px;
            display: flex;
            gap: 32px;
        }
        .editor-empty {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            gap: 12px;
            color: var(--gray-400);
        }
        .editor-empty svg {
            width: 48px;
            height: 48px;
            stroke: var(--gray-300);
        }

        /* Form */
        .editor-form {
            flex: 1;
            max-width: 560px;
        }
        .form-section {
            margin-bottom: 28px;
        }
        .form-section-title {
            font-family: var(--font-display);
            font-size: 13px;
            font-weight: 700;
            color: var(--gray-400);
            text-transform: uppercase;
            letter-spacing: 0.1em;
            margin-bottom: 16px;
            padding-bottom: 8px;
            border-bottom: 1px solid var(--gray-100);
        }
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
            margin-bottom: 16px;
        }
        .form-row.triple {
            grid-template-columns: 1fr 1fr 1fr;
        }
        .form-group {
            margin-bottom: 16px;
        }
        .form-group label {
            display: block;
            font-size: 12px;
            font-weight: 600;
            color: var(--gray-600);
            margin-bottom: 6px;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 10px 12px;
            font-size: 14px;
            font-family: var(--font-body);
            border: 1px solid var(--gray-200);
            border-radius: 8px;
            background: var(--white);
            color: var(--rich-black);
            transition: all 0.2s;
        }
        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--electric-blue);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }
        .form-group textarea {
            resize: vertical;
            min-height: 80px;
        }
        .form-group input.error,
        .form-group select.error {
            border-color: var(--hot-pink);
        }

        /* Image Upload */
        .image-upload-zone {
            border: 2px dashed var(--gray-300);
            border-radius: 12px;
            padding: 24px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            background: var(--gray-50);
            position: relative;
        }
        .image-upload-zone:hover,
        .image-upload-zone.dragover {
            border-color: var(--electric-blue);
            background: var(--gradient-subtle);
        }
        .image-upload-zone.has-image {
            padding: 0;
            border-style: solid;
            border-color: var(--gray-200);
        }
        .image-upload-zone .upload-icon {
            width: 40px;
            height: 40px;
            stroke: var(--gray-400);
            margin-bottom: 8px;
        }
        .image-upload-zone .upload-text {
            font-size: 13px;
            color: var(--gray-500);
        }
        .image-upload-zone .upload-text strong {
            color: var(--electric-blue);
        }
        .image-upload-zone input[type="file"] {
            position: absolute;
            inset: 0;
            opacity: 0;
            cursor: pointer;
        }
        .image-preview {
            width: 100%;
            aspect-ratio: 1;
            object-fit: cover;
            border-radius: 10px;
            display: block;
        }
        .image-actions {
            display: flex;
            gap: 8px;
            margin-top: 8px;
        }

        /* Live Preview */
        .preview-panel {
            width: 300px;
            flex-shrink: 0;
            position: sticky;
            top: 32px;
            align-self: flex-start;
        }
        .preview-label {
            font-family: var(--font-display);
            font-size: 13px;
            font-weight: 700;
            color: var(--gray-400);
            text-transform: uppercase;
            letter-spacing: 0.1em;
            margin-bottom: 16px;
        }
        .preview-card {
            background: var(--white);
            border-radius: 20px;
            overflow: hidden;
            border: 1px solid var(--gray-100);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.06);
        }
        .preview-card-illustration {
            aspect-ratio: 1;
            background: var(--gradient-subtle);
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            overflow: hidden;
        }
        .preview-card-illustration.has-image {
            background: var(--gray-100);
        }
        .preview-card-illustration svg {
            width: 60%;
            height: 60%;
            stroke: var(--gray-400);
        }
        .preview-card-illustration img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .preview-card-badge {
            position: absolute;
            top: 12px;
            right: 12px;
            padding: 4px 12px;
            font-size: 10px;
            font-weight: 700;
            letter-spacing: 0.1em;
            text-transform: uppercase;
            border-radius: 100px;
            color: var(--white);
        }
        .preview-card-badge.essential { background: var(--electric-blue); }
        .preview-card-badge.signature { background: var(--gradient); }
        .preview-card-badge.premium { background: linear-gradient(135deg, var(--gold) 0%, #B8941E 100%); }
        .preview-card-info { padding: 20px; }
        .preview-card-info h3 {
            font-family: var(--font-display);
            font-size: 16px;
            font-weight: 700;
            color: var(--rich-black);
            margin-bottom: 6px;
        }
        .preview-card-info p {
            font-size: 13px;
            color: var(--gray-500);
            line-height: 1.5;
            margin-bottom: 16px;
        }
        .preview-card-meta {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding-top: 12px;
            border-top: 1px solid var(--gray-100);
        }
        .preview-card-price {
            font-family: var(--font-display);
            font-size: 16px;
            font-weight: 700;
            background: var(--gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        .preview-card-method {
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--gray-400);
            padding: 4px 10px;
            background: var(--gray-50);
            border-radius: 100px;
        }

        /* Editor Actions */
        .editor-actions {
            display: flex;
            gap: 10px;
            margin-top: 24px;
            padding-top: 20px;
            border-top: 1px solid var(--gray-100);
        }

        /* Toast Notifications */
        .toast {
            position: fixed;
            bottom: 24px;
            right: 24px;
            padding: 14px 20px;
            background: var(--rich-black);
            color: var(--white);
            border-radius: 12px;
            font-size: 14px;
            font-weight: 500;
            z-index: 1000;
            transform: translateY(100px);
            opacity: 0;
            transition: all 0.3s var(--ease);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }
        .toast.visible {
            transform: translateY(0);
            opacity: 1;
        }
        .toast.success { border-left: 4px solid #34D399; }
        .toast.error { border-left: 4px solid var(--hot-pink); }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: var(--gray-300); border-radius: 3px; }
    </style>
</head>
<body>

<!-- Auth Gate -->
<div class="auth-gate" id="authGate">
    <img src="assets/Submark.svg" alt="" style="width: 48px; opacity: 0.6;">
    <h1>Product Manager</h1>
    <p>Enter the admin passphrase to continue</p>
    <input type="password" id="authInput" placeholder="Passphrase" autofocus>
    <p class="auth-error" id="authError">Incorrect passphrase</p>
</div>

<!-- App -->
<div class="app locked" id="app">
    <!-- Top Bar -->
    <div class="topbar">
        <div class="topbar-left">
            <img src="assets/Submark.svg" alt="" class="topbar-logo" style="filter: brightness(10);">
            <h1>Product Manager</h1>
        </div>
        <div class="topbar-actions">
            <button class="btn btn-secondary" onclick="exportJSON()" title="Download catalog.json">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
                Export JSON
            </button>
            <button class="btn btn-primary" onclick="downloadAll()" title="Download JSON + images as zip">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
                Download All
            </button>
        </div>
    </div>

    <!-- Main Area -->
    <div class="main">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="sidebar-header">
                <h2>Products</h2>
                <span class="product-count" id="productCount">0</span>
            </div>
            <div class="product-list" id="productList"></div>
            <div class="sidebar-footer">
                <button class="btn btn-primary btn-add" onclick="addProduct()">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
                    Add Product
                </button>
            </div>
        </div>

        <!-- Editor Area -->
        <div class="editor" id="editorArea">
            <div class="editor-empty" id="editorEmpty">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><rect x="3" y="3" width="18" height="18" rx="2"/><line x1="9" y1="3" x2="9" y2="21"/></svg>
                <p>Select a product to edit or add a new one</p>
            </div>
        </div>
    </div>
</div>

<!-- Toast -->
<div class="toast" id="toast"></div>

<script>
// ================================
// State
// ================================
let products = [];
let imageStore = {}; // id -> { dataUrl, fileName }
let selectedId = null;
let hasUnsavedChanges = false;

const PASSPHRASE = 'mitzvah2026';

const CATEGORIES = [
    { value: 'tops', label: 'Tops' },
    { value: 'bottoms', label: 'Bottoms' },
    { value: 'accessories', label: 'Accessories' },
    { value: 'sleepwear', label: 'Sleepwear' }
];

const GARMENT_TYPES = [
    { value: 't-shirt', label: 'T-Shirt' },
    { value: 'tank-top', label: 'Tank Top' },
    { value: 'crop-top', label: 'Crop Top' },
    { value: 'hoodie', label: 'Hoodie' },
    { value: 'sweatshirt', label: 'Sweatshirt' },
    { value: 'polo', label: 'Polo' },
    { value: 'jacket', label: 'Jacket' },
    { value: 'shorts', label: 'Shorts' },
    { value: 'joggers', label: 'Joggers' },
    { value: 'hat', label: 'Hat' },
    { value: 'tote-bag', label: 'Bag' },
    { value: 'pajama-set', label: 'Pajama Set' },
    { value: 'sleep-mask', label: 'Sleep Mask' },
    { value: 'robe', label: 'Robe' },
    { value: 'socks', label: 'Socks' }
];

const METHODS = [
    { value: 'cut-and-sew', label: 'Cut & Sew' },
    { value: 'screen-print', label: 'Screen Print' },
    { value: 'embroidered', label: 'Embroidered' }
];

const BADGES = [
    { value: '', label: 'None' },
    { value: 'ESSENTIAL', label: 'Essential' },
    { value: 'SIGNATURE', label: 'Signature' },
    { value: 'PREMIUM', label: 'Premium' }
];

// ================================
// Auth
// ================================
document.getElementById('authInput').addEventListener('keydown', (e) => {
    if (e.key === 'Enter') {
        const val = e.target.value;
        if (val === PASSPHRASE) {
            document.getElementById('authGate').classList.add('hidden');
            document.getElementById('app').classList.remove('locked');
            loadCatalog();
        } else {
            document.getElementById('authError').style.display = 'block';
            e.target.value = '';
            e.target.focus();
        }
    }
});

// ================================
// Data Loading
// ================================
async function loadCatalog() {
    try {
        const res = await fetch('data/catalog.json');
        products = await res.json();
        renderProductList();
        showToast('Catalog loaded — ' + products.length + ' products', 'success');
    } catch (err) {
        products = [];
        renderProductList();
        showToast('Could not load catalog.json — starting fresh', 'error');
    }
}

// ================================
// Product List
// ================================
function renderProductList() {
    const list = document.getElementById('productList');
    document.getElementById('productCount').textContent = products.length;

    list.innerHTML = products.map(p => {
        const thumbHTML = (imageStore[p.id] && imageStore[p.id].dataUrl)
            ? `<img src="${imageStore[p.id].dataUrl}" alt="">`
            : (p.image
                ? `<img src="${p.image}" alt="">`
                : `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/><path d="M21 15l-5-5L5 21"/></svg>`
            );

        return `
            <div class="product-list-item ${p.id === selectedId ? 'active' : ''}" onclick="selectProduct('${p.id}')">
                <div class="item-thumb">${thumbHTML}</div>
                <div class="item-info">
                    <div class="item-name">${p.name || 'Untitled'}</div>
                    <div class="item-meta">${p.category || 'No category'} · $${p.priceMin || '?'}–$${p.priceMax || '?'}</div>
                </div>
            </div>
        `;
    }).join('');
}

// ================================
// Select / Edit Product
// ================================
function selectProduct(id) {
    selectedId = id;
    renderProductList();
    renderEditor();
}

function renderEditor() {
    const area = document.getElementById('editorArea');
    const product = products.find(p => p.id === selectedId);

    if (!product) {
        area.innerHTML = `
            <div class="editor-empty" id="editorEmpty">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><rect x="3" y="3" width="18" height="18" rx="2"/><line x1="9" y1="3" x2="9" y2="21"/></svg>
                <p>Select a product to edit or add a new one</p>
            </div>
        `;
        return;
    }

    const imgData = imageStore[product.id];
    const imgSrc = (imgData && imgData.dataUrl) ? imgData.dataUrl : product.image;

    area.innerHTML = `
        <div class="editor-form">
            <div class="form-section">
                <div class="form-section-title">Product Details</div>
                <div class="form-group">
                    <label>Product Name *</label>
                    <input type="text" id="f-name" value="${esc(product.name)}" oninput="updateField('name', this.value)">
                </div>
                <div class="form-group">
                    <label>Description</label>
                    <textarea id="f-desc" oninput="updateField('description', this.value)">${esc(product.description)}</textarea>
                </div>
            </div>

            <div class="form-section">
                <div class="form-section-title">Classification</div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Category *</label>
                        <select id="f-category" onchange="updateField('category', this.value)">
                            ${CATEGORIES.map(c => `<option value="${c.value}" ${product.category === c.value ? 'selected' : ''}>${c.label}</option>`).join('')}
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Garment Type *</label>
                        <select id="f-garmentType" onchange="updateField('garmentType', this.value)">
                            ${GARMENT_TYPES.map(g => `<option value="${g.value}" ${product.garmentType === g.value ? 'selected' : ''}>${g.label}</option>`).join('')}
                        </select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Production Method *</label>
                        <select id="f-method" onchange="updateField('productionMethod', this.value)">
                            ${METHODS.map(m => `<option value="${m.value}" ${product.productionMethod === m.value ? 'selected' : ''}>${m.label}</option>`).join('')}
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Badge</label>
                        <select id="f-badge" onchange="updateField('badge', this.value || null)">
                            ${BADGES.map(b => `<option value="${b.value}" ${(product.badge || '') === b.value ? 'selected' : ''}>${b.label}</option>`).join('')}
                        </select>
                    </div>
                </div>
            </div>

            <div class="form-section">
                <div class="form-section-title">Pricing</div>
                <div class="form-row triple">
                    <div class="form-group">
                        <label>Min Price ($) *</label>
                        <input type="number" id="f-priceMin" value="${product.priceMin || ''}" oninput="updateField('priceMin', Number(this.value))">
                    </div>
                    <div class="form-group">
                        <label>Max Price ($) *</label>
                        <input type="number" id="f-priceMax" value="${product.priceMax || ''}" oninput="updateField('priceMax', Number(this.value))">
                    </div>
                    <div class="form-group">
                        <label>Min Order</label>
                        <input type="number" id="f-minOrder" value="${product.minOrder || ''}" oninput="updateField('minOrder', Number(this.value))">
                    </div>
                </div>
            </div>

            <div class="form-section">
                <div class="form-section-title">Product Image</div>
                <div class="image-upload-zone ${imgSrc ? 'has-image' : ''}" id="imageZone"
                     ondragover="event.preventDefault(); this.classList.add('dragover')"
                     ondragleave="this.classList.remove('dragover')"
                     ondrop="handleImageDrop(event)">
                    ${imgSrc
                        ? `<img src="${imgSrc}" class="image-preview" id="imagePreview">`
                        : `<svg class="upload-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                               <rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/><path d="M21 15l-5-5L5 21"/>
                           </svg>
                           <p class="upload-text"><strong>Click to upload</strong> or drag and drop<br>JPG, PNG, or WebP (max 2MB)</p>`
                    }
                    <input type="file" accept="image/jpeg,image/png,image/webp" onchange="handleImageSelect(event)">
                </div>
                ${imgSrc ? `
                    <div class="image-actions">
                        <button class="btn btn-ghost" onclick="removeImage()">Remove Image</button>
                    </div>
                ` : ''}
                <div class="form-group" style="margin-top: 12px;">
                    <label>Image Alt Text</label>
                    <input type="text" id="f-imageAlt" value="${esc(product.imageAlt || '')}" oninput="updateField('imageAlt', this.value)" placeholder="Describe the product image">
                </div>
            </div>

            <div class="editor-actions">
                <button class="btn btn-danger" onclick="deleteProduct('${product.id}')">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/></svg>
                    Delete Product
                </button>
            </div>
        </div>

        <div class="preview-panel">
            <div class="preview-label">Live Preview</div>
            <div class="preview-card" id="previewCard">
                ${renderPreviewCard(product)}
            </div>
        </div>
    `;
}

function renderPreviewCard(product) {
    const imgData = imageStore[product.id];
    const imgSrc = (imgData && imgData.dataUrl) ? imgData.dataUrl : product.image;

    const badgeHTML = product.badge
        ? `<span class="preview-card-badge ${product.badge.toLowerCase()}">${product.badge}</span>`
        : '';

    const illustrationHTML = imgSrc
        ? `<img src="${imgSrc}" alt="${product.imageAlt || product.name}">`
        : getGarmentSVG(product.garmentType);

    const methodLabels = { 'cut-and-sew': 'Cut & Sew', 'screen-print': 'Screen Print', 'embroidered': 'Embroidered' };

    return `
        <div class="preview-card-illustration${imgSrc ? ' has-image' : ''}">
            ${illustrationHTML}
            ${badgeHTML}
        </div>
        <div class="preview-card-info">
            <h3>${product.name || 'Untitled Product'}</h3>
            <p>${product.description || 'No description yet.'}</p>
            <div class="preview-card-meta">
                <span class="preview-card-price">$${product.priceMin || '?'}–$${product.priceMax || '?'}</span>
                <span class="preview-card-method">${methodLabels[product.productionMethod] || product.productionMethod}</span>
            </div>
        </div>
    `;
}

// ================================
// Field Updates
// ================================
function updateField(field, value) {
    const product = products.find(p => p.id === selectedId);
    if (!product) return;
    product[field] = value;
    hasUnsavedChanges = true;

    // Update preview
    const preview = document.getElementById('previewCard');
    if (preview) preview.innerHTML = renderPreviewCard(product);

    // Update sidebar name/meta
    renderProductList();
}

// ================================
// Image Handling
// ================================
function handleImageSelect(e) {
    const file = e.target.files[0];
    if (file) processImage(file);
}

function handleImageDrop(e) {
    e.preventDefault();
    e.currentTarget.classList.remove('dragover');
    const file = e.dataTransfer.files[0];
    if (file && file.type.startsWith('image/')) processImage(file);
}

function processImage(file) {
    if (file.size > 5 * 1024 * 1024) {
        showToast('Image too large. Max 5MB.', 'error');
        return;
    }

    const reader = new FileReader();
    reader.onload = (e) => {
        const img = new Image();
        img.onload = () => {
            // Resize to max 800x800
            const maxSize = 800;
            let w = img.width, h = img.height;
            if (w > maxSize || h > maxSize) {
                if (w > h) { h = Math.round(h * maxSize / w); w = maxSize; }
                else { w = Math.round(w * maxSize / h); h = maxSize; }
            }
            const canvas = document.createElement('canvas');
            canvas.width = w;
            canvas.height = h;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(img, 0, 0, w, h);
            const dataUrl = canvas.toDataURL('image/jpeg', 0.85);

            const ext = file.name.split('.').pop().toLowerCase();
            const product = products.find(p => p.id === selectedId);

            imageStore[selectedId] = {
                dataUrl: dataUrl,
                fileName: `${selectedId}.${ext === 'webp' ? 'webp' : 'jpg'}`
            };

            if (product) {
                product.image = `images/products/${imageStore[selectedId].fileName}`;
            }

            hasUnsavedChanges = true;
            renderEditor();
            renderProductList();
            showToast('Image uploaded', 'success');
        };
        img.src = e.target.result;
    };
    reader.readAsDataURL(file);
}

function removeImage() {
    const product = products.find(p => p.id === selectedId);
    if (!product) return;
    delete imageStore[selectedId];
    product.image = '';
    hasUnsavedChanges = true;
    renderEditor();
    renderProductList();
}

// ================================
// Add / Delete
// ================================
function addProduct() {
    const maxNum = products.reduce((max, p) => {
        const num = parseInt(p.id.replace('ms-', ''));
        return num > max ? num : max;
    }, 0);

    const newId = 'ms-' + String(maxNum + 1).padStart(3, '0');
    const newProduct = {
        id: newId,
        name: '',
        category: 'tops',
        garmentType: 't-shirt',
        productionMethod: 'screen-print',
        priceMin: 0,
        priceMax: 0,
        minOrder: 15,
        badge: null,
        description: '',
        image: '',
        imageAlt: ''
    };

    products.push(newProduct);
    hasUnsavedChanges = true;
    selectedId = newId;
    renderProductList();
    renderEditor();

    // Focus the name field
    setTimeout(() => {
        const nameInput = document.getElementById('f-name');
        if (nameInput) nameInput.focus();
    }, 50);

    showToast('New product added', 'success');
}

function deleteProduct(id) {
    if (!confirm('Delete this product? This cannot be undone.')) return;
    products = products.filter(p => p.id !== id);
    delete imageStore[id];
    selectedId = products.length > 0 ? products[0].id : null;
    hasUnsavedChanges = true;
    renderProductList();
    renderEditor();
    showToast('Product deleted', 'success');
}

// ================================
// Export
// ================================
function exportJSON() {
    const json = JSON.stringify(products, null, 2);
    downloadFile('catalog.json', json, 'application/json');
    showToast('catalog.json downloaded', 'success');
}

async function downloadAll() {
    const hasImages = Object.keys(imageStore).length > 0;

    if (!hasImages) {
        exportJSON();
        return;
    }

    showToast('Preparing download...', 'success');

    // Use simple zip approach - just download JSON + provide instructions
    // For actual zip, we'd need JSZip which is heavy. Instead, download the JSON
    // and the images separately with clear naming.
    exportJSON();

    // Download each image separately
    for (const [id, img] of Object.entries(imageStore)) {
        if (img.dataUrl) {
            const link = document.createElement('a');
            link.href = img.dataUrl;
            link.download = img.fileName;
            link.click();
        }
    }

    setTimeout(() => {
        showToast('Files downloaded! Place images in images/products/ folder', 'success');
    }, 500);
}

function downloadFile(name, content, type) {
    const blob = new Blob([content], { type });
    const url = URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.href = url;
    link.download = name;
    link.click();
    URL.revokeObjectURL(url);
}

// ================================
// Utilities
// ================================
function esc(str) {
    if (!str) return '';
    return str.replace(/&/g, '&amp;').replace(/"/g, '&quot;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
}

function showToast(message, type = 'success') {
    const toast = document.getElementById('toast');
    toast.textContent = message;
    toast.className = 'toast ' + type;
    requestAnimationFrame(() => {
        toast.classList.add('visible');
    });
    setTimeout(() => toast.classList.remove('visible'), 3000);
}

// Unsaved changes warning
window.addEventListener('beforeunload', (e) => {
    if (hasUnsavedChanges) {
        e.preventDefault();
        e.returnValue = '';
    }
});

// ================================
// SVG Garment Illustrations (same as catalog)
// ================================
function getGarmentSVG(type) {
    const svgs = {
        't-shirt': `<svg viewBox="0 0 120 120" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M35 30L20 40L28 55L35 48V95H85V48L92 55L100 40L85 30"/><path d="M35 30C35 30 45 42 60 42C75 42 85 30 85 30"/></svg>`,
        'tank-top': `<svg viewBox="0 0 120 120" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M40 25C40 25 48 35 60 35C72 35 80 25 80 25"/><path d="M40 25L38 45L38 95H82V45L80 25"/></svg>`,
        'crop-top': `<svg viewBox="0 0 120 120" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M35 30L20 40L28 55L35 48V72H85V48L92 55L100 40L85 30"/><path d="M35 30C35 30 45 42 60 42C75 42 85 30 85 30"/><line x1="35" y1="72" x2="85" y2="72" stroke-dasharray="4 3"/></svg>`,
        'hoodie': `<svg viewBox="0 0 120 120" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M35 30L18 42L27 58L35 50V95H85V50L93 58L102 42L85 30"/><path d="M35 30C35 30 45 42 60 42C75 42 85 30 85 30"/><path d="M50 42V60C50 60 52 65 60 65C68 65 70 60 70 60V42"/><rect x="45" y="70" width="30" height="18" rx="3"/></svg>`,
        'sweatshirt': `<svg viewBox="0 0 120 120" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M35 30L18 42L27 58L35 50V95H85V50L93 58L102 42L85 30"/><path d="M35 30C35 30 45 42 60 42C75 42 85 30 85 30"/><path d="M35 80H85" stroke-dasharray="4 3"/></svg>`,
        'polo': `<svg viewBox="0 0 120 120" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M35 30L20 40L28 55L35 48V95H85V48L92 55L100 40L85 30"/><path d="M35 30C35 30 45 40 60 40C75 40 85 30 85 30"/><path d="M55 30V50"/><path d="M65 30V50"/><circle cx="60" cy="37" r="2"/><circle cx="60" cy="45" r="2"/></svg>`,
        'jacket': `<svg viewBox="0 0 120 120" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M35 28L18 40L27 56L35 48V95H85V48L93 56L102 40L85 28"/><path d="M35 28C35 28 45 40 60 40C75 40 85 28 85 28"/><line x1="60" y1="40" x2="60" y2="95"/><rect x="40" y="70" width="14" height="14" rx="2"/><rect x="66" y="70" width="14" height="14" rx="2"/></svg>`,
        'shorts': `<svg viewBox="0 0 120 120" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M30 30H90V50C90 50 90 60 82 72L72 88H64L60 65L56 88H48L38 72C30 60 30 50 30 50V30Z"/><path d="M30 38H90" stroke-dasharray="4 3"/></svg>`,
        'joggers': `<svg viewBox="0 0 120 120" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M35 20H85V40C85 40 85 55 80 70L75 100H65L60 55L55 100H45L40 70C35 55 35 40 35 40V20Z"/><path d="M35 28H85" stroke-dasharray="4 3"/><path d="M43 95H77" opacity="0.5"/></svg>`,
        'hat': `<svg viewBox="0 0 120 120" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><ellipse cx="60" cy="70" rx="40" ry="10"/><path d="M25 70C25 70 28 35 60 35C92 35 95 70 95 70"/><path d="M20 70L60 75"/><rect x="50" y="35" width="20" height="8" rx="4"/></svg>`,
        'tote-bag': `<svg viewBox="0 0 120 120" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><rect x="28" y="45" width="64" height="55" rx="4"/><path d="M45 45V32C45 32 45 20 60 20C75 20 75 32 75 32V45"/></svg>`,
        'pajama-set': `<svg viewBox="0 0 120 120" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M40 15L30 22L35 32L40 28V52H55V28L50 32"/><path d="M65 15L75 22L70 32L65 28V52H80V28L85 32"/><path d="M40 15C40 15 44 22 47.5 22C51 22 55 15 55 15"/><path d="M65 15C65 15 69 22 72.5 22C76 22 80 15 80 15"/><path d="M35 60H55V85C55 85 55 92 52 100H48L45 75L42 100H38C35 92 35 85 35 85V60Z"/><path d="M65 60H85V85C85 85 85 92 82 100H78L75 75L72 100H68C65 92 65 85 65 85V60Z"/></svg>`,
        'sleep-mask': `<svg viewBox="0 0 120 120" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M20 55C20 45 30 38 45 38C52 38 57 42 60 45C63 42 68 38 75 38C90 38 100 45 100 55C100 65 90 75 75 75C68 75 63 70 60 67C57 70 52 75 45 75C30 75 20 65 20 55Z"/><path d="M15 52L20 55" stroke-dasharray="3 3"/><path d="M100 55L105 52" stroke-dasharray="3 3"/><ellipse cx="43" cy="57" rx="8" ry="6" opacity="0.3"/><ellipse cx="77" cy="57" rx="8" ry="6" opacity="0.3"/></svg>`,
        'robe': `<svg viewBox="0 0 120 120" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M40 25L35 100H50L55 60L60 45L65 60L70 100H85L80 25"/><path d="M40 25C40 25 48 35 60 35C72 35 80 25 80 25"/><path d="M45 55L75 55"/><path d="M48 55L45 70H75L72 55"/></svg>`,
        'socks': `<svg viewBox="0 0 120 120" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M40 20H55V70C55 70 55 85 65 92C75 99 85 95 85 85C85 75 75 70 65 70H55"/><path d="M40 30H55" stroke-dasharray="3 3"/><path d="M40 20H55"/></svg>`
    };
    return svgs[type] || svgs['t-shirt'];
}
</script>
</body>
</html>
